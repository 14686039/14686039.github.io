
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>activeMQ快速上手 | 技术与生活</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ActiveMQ基础ActiveMQ简介ActiveMQ是什么ActiveMQ是Apache推出的,一款开源的,完全支持JMS1.1和J2EE1.4规范的JMSProvider实现的消息中间件(MessageOrientedMiddleware,MOM)
ActiveMQ能干什么最主要的功能就是:实现JMSProvider,用来帮助实现高可用、高性能、可伸缩、易用和安全的企业级面向消息服务的系统A">
<meta property="og:type" content="article">
<meta property="og:title" content="activeMQ快速上手">
<meta property="og:url" content="http://14686039.github.io/2015/11/26/activeMQ快速上手/index.html">
<meta property="og:site_name" content="技术与生活">
<meta property="og:description" content="ActiveMQ基础ActiveMQ简介ActiveMQ是什么ActiveMQ是Apache推出的,一款开源的,完全支持JMS1.1和J2EE1.4规范的JMSProvider实现的消息中间件(MessageOrientedMiddleware,MOM)
ActiveMQ能干什么最主要的功能就是:实现JMSProvider,用来帮助实现高可用、高性能、可伸缩、易用和安全的企业级面向消息服务的系统A">
<meta property="og:image" content="http://i65.tinypic.com/ixegli.jpg">
<meta property="og:image" content="http://i64.tinypic.com/2aikbxk.jpg">
<meta property="og:updated_time" content="2015-11-26T08:20:37.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="activeMQ快速上手">
<meta name="twitter:description" content="ActiveMQ基础ActiveMQ简介ActiveMQ是什么ActiveMQ是Apache推出的,一款开源的,完全支持JMS1.1和J2EE1.4规范的JMSProvider实现的消息中间件(MessageOrientedMiddleware,MOM)
ActiveMQ能干什么最主要的功能就是:实现JMSProvider,用来帮助实现高可用、高性能、可伸缩、易用和安全的企业级面向消息服务的系统A">
  
    <link rel="alternative" href="/atom.xml" title="技术与生活" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
</head>
<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">技术与生活</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">热爱技术、更爱生活</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于我</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="http://www.baidu.com/baidu" method="get" accept-charset="utf-8" class="search-form">
          <input type="search" name="word" maxlength="20" class="search-form-input" placeholder="Search">
          <input type="submit" value="" class="search-form-submit">
          <input name=tn type=hidden value="bds">
          <input name=cl type=hidden value="3">
          <input name=ct type=hidden value="2097152">
          <input type="hidden" name="si" value="14686039.github.io">
        </form>
      </div>
    </div>
  </div>
</header>
    <div class="outer">
      <section id="main"><article id="post-activeMQ快速上手" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/26/activeMQ快速上手/" class="article-date">
  <time datetime="2015-11-26T08:20:37.000Z" itemprop="datePublished">2015-11-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      activeMQ快速上手
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="ActiveMQ基础">ActiveMQ基础</h1><h2 id="ActiveMQ简介">ActiveMQ简介</h2><p>ActiveMQ是什么ActiveMQ是Apache推出的,一款开源的,完全支持JMS1.1和J2EE1.4规范的<br>JMSProvider实现的消息中间件(MessageOrientedMiddleware,MOM)</p>
<h3 id="ActiveMQ能干什么">ActiveMQ能干什么</h3><p>最主要的功能就是:<br>实现JMSProvider,用来帮助实现高可用、高性能、可伸缩、易用和安全的企业级面向消息服务的系统<br>ActiveMQ特点完全支持JMS1.1和J2EE1.4规范(持久化,XA消息,事务)支持多种传送协议:in-VM,TCP,SSL,NIO,UDP,JGroups,JXTA可插拔的体系结构,可以灵活定制,如:消息存储方式、安全管理等很容易和ApplicatioServer集成使用多种语言和协议编写客户端。语言:Java,C,C++,C#,Ruby,Perl,Python,PHP<br>从设计上保证了高性能的集群,客户端-服务器,点对点,可以很容易的和Spring结合使用<br>支持通过JDBC和journal提供高速的消息持久化支持与Axis的整合</p>
<h2 id="消息中间件">消息中间件</h2><p>MOM基本功能:将信息以消息的形式,从一个应用程序传送到另一个或多个应用程序。<br>MOM主要特点:1:消息异步接受,类似手机短信的行为,消息发送者不需要等待消息接受者的响应,减少软<br>件多系统集成的耦合度;2:消息可靠接收,确保消息在中间件可靠保存,只有接收方收到后才删除消息,多个消息也可以组成原子事务<br>消息中间件的主要应用场景:<br>在多个系统间进行整合和通讯的时候,通常会要求:<br>1:可靠传输,数据不能丢失,有的时候,也会要求不能重复传输;<br>2:异步传输,否则各个系统同步发送接受数据,互相等待,造成系统瓶颈</p>
<h2 id="ActiveMQ安装和基本使用">ActiveMQ安装和基本使用</h2><p>下载并安装ActiveMQ服务器端1:从<a href="http://activemq.apache.org/download.html下载最新的ActiveMQ2:直接解压,然后拷贝到你要安装的位置就好了" target="_blank" rel="external">http://activemq.apache.org/download.html下载最新的ActiveMQ2:直接解压,然后拷贝到你要安装的位置就好了</a><br>启动运行<br>1:普通启动:到ActiveMQ/bin下面,./activemqstart<br>2:启动并指定日志文件./activemqstart&gt;/tmp/activemqlog<br>检查是否已经启动ActiveMQ默认采用61616端口提供JMS服务,使用8161端口提供管理控制台服务,执行以下命令以便检验是否已经成功启动ActiveMQ服务:<br>1:比如查看61616端口是否打开:netstat-a|grep61616<br>2:也可以直接查看控制台输出或者日志文件3:还可以直接访问ActiveMQ的管理页面:<a href="http://192.168.1.106:8161/admin/" target="_blank" rel="external">http://192.168.1.106:8161/admin/</a><br>默认的用户名和密码是admin/admin<br>关闭ActiveMQ,可以用./activemqstop<br>暴力点的可以用ps-ef|grepactivemq来得到进程号,然后kill掉</p>
<p>Demo<br>基本的Queue消息发送-1<br>配置Maven所需的依赖,示例如下:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">groupId</span>&gt;</span>org.apache.activemq<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>activemq-all<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">version</span>&gt;</span>5.9.0<span class="tag">&lt;/<span class="title">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="title">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">artifactId</span>&gt;</span>xbean-spring<span class="tag">&lt;/<span class="title">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">version</span>&gt;</span>3.16<span class="tag">&lt;/<span class="title">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>Queue消息发送的示例代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsSend</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[]args)</span>throwsExceptio</span>&#123;</span><br><span class="line">		ConnectionFactory connectionFactory=<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.1.106:61616"</span>);</span><br><span class="line">		Connectioconnectio=connectionFactory.createConnection();connection.start();</span><br><span class="line">		Sessiosessio=connection.createSession(Boolean.TRUE,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">		Destinatio destinatio=session.createQueue(<span class="string">"my-queue"</span>);</span><br><span class="line">		MessageProducer producer=session.createProducer(destination);<span class="keyword">for</span>(inti=<span class="number">0</span>;i&lt;<span class="number">3</span>;i++)&#123;</span><br><span class="line">		TextMessage message=session.createTextMessage(<span class="string">"message--"</span>+i);Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		<span class="comment">//通过消息生产者发出消息</span></span><br><span class="line">		producer.send(message);</span><br><span class="line">		&#125;</span><br><span class="line">		session.commit();</span><br><span class="line">	session.close();</span><br><span class="line">	connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JmsReceiver</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[]args)</span>throwsExceptio</span>&#123;</span><br><span class="line">		ConnectionFactory cf=<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.1.106:61616"</span>);</span><br><span class="line">		Connectioconnectio=cf.createConnection();</span><br><span class="line">		connection.start();</span><br><span class="line">		<span class="keyword">final</span> Sessio sessio=connection.createSession(Boolean.TRUE,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">		Destinatiodestinatio=session.createQueue(<span class="string">"my-queue"</span>);</span><br><span class="line">		MessageConsumer consumer=session.createConsumer(destination);inti=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span>(i&lt;<span class="number">3</span>)&#123;</span><br><span class="line">			i++;</span><br><span class="line">			TextMessage message=(TextMessage)consumer.receive();</span><br><span class="line">			session.commit();</span><br><span class="line">			System.out.println(<span class="string">"收到消息:"</span>+message.getText());</span><br><span class="line">		&#125;</span><br><span class="line">		session.close();</span><br><span class="line">	connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="JMS基本概念">JMS基本概念</h2><p>JMS是什么<br>JMSJavaMessageService,Java消息服务,是JavaEE中的一个技术。<br>JMS规范<br>JMS定义了Java中访问消息中间件的接口,并没有给予实现,实现JMS接口的消息<br>中间件称为JMSProvider,例如ActiveMQ<br><strong>JMSprovider:实现JMS接口和规范的消息中间件</strong><br>JMSmessage:JMS的消息,JMS消息由以下三部分组成:<br>1:消息头:每个消息头字段都有相应的getter和setter方法<br>2:消息属性:如果需要除消息头字段以外的值,那么可以使用消息属性<br>3:消息体:封装具体的消息数据<br>JMSproducer:消息生产者,创建和发送JMS消息的客户端应用<br>JMSconsumer:消息消费者,接收和处理JMS消息的客户端应用<br><em>消息的消费可以采用以下两种方法之一:</em></p>
<blockquote>
<p>1:同步消费:通过调用消费者的receive方法从目的地中显式提取消息,receive方法可以一直阻塞到消息到达。<br>2:异步消费:客户可以为消费者注册一个消息监听器,以定义在消息到达时所采取的动作<br>JMSdomains:消息传递域,JMS规范中定义了两种消息传递域:</p>
<h2 id="点对点(point-to-point,简写成PTP)">点对点(point-to-point,简写成PTP)</h2><p>消息传递域和发布/订阅消息传递域(publish/subscribe,简写成pub/sub)<br>1:点对点消息传递域的特点如下:<br>(1)每个消息只能有一个消费者<br>(2)消息的生产者和消费者之间没有时间上的相关性。<br>无论消费者在生产者发送消息的时候是否处于运行状态,它都可以提取消息。<br><img src="http://i65.tinypic.com/ixegli.jpg" alt="点对点"></p>
</blockquote>
<p>2:发布/订阅消息传递域的特点如下:<br>(1)每个消息可以有多个消费者<br>(2)生产者和消费者之间有时间上的相关性。订阅一个主题的消费者只能消费自它订阅之后发布的消息。JMS规范允许客户创建持久订阅,这在一定程度上放松了时间上的相关性要求。持久订阅允许消费者消费它在未处于激活状态时发送的消息。<br><img src="http://i64.tinypic.com/2aikbxk.jpg" alt="发布/订阅"></p>
<p>3:在点对点消息传递域中,目的地被称为队列(queue);在发布/订阅消息传递域中,目的地被称为主题(topic)</p>
<p>###一些术语<br>Connectiofactory:连接工厂,用来创建连接对象,以连接到JMS的providerJMSConnection:封装了客户与JMS提供者之间的一个虚拟的连接<br>JMSSession:是生产和消费消息的一个单线程上下文<br><em>会话用于创建消息生产者(producer)、消息消费者(consumer)和消息(message)等。会话提供了一个事务性的上下文,在这个上下文中,一组发送和接收被组合到了一个原子操作中。</em><br>Destination:消息发送到的目的地<br>Acknowledge:签收<br>Transaction:事务<br>JMSclient:用来收发消息的Java应用<br>Non-JMSclient:使用JMSprovider本地API写的应用,用来替换JMSAPI实现收发消息的功能,通常会提供其他的一些特性,比如:CORBA、RMI等。<br>Administeredobjects:预定义的JMS对象,通常在provider规范中有定义,提供给JMS客户端来访问,比如:ConnectionFactory和Destination</p>
<h3 id="JMS消息结构">JMS消息结构</h3><p>JMS消息由以下几部分组成:消息头,属性和消息体<br>消息头包含消息的识别信息和路由信息,消息头包含一些标准的属性如下:<br>1:JMSDestination:由send方法设置<br>2:JMSDeliveryMode:由send方法设置<br>3:JMSExpiration:由send方法设置<br>4:JMSPriority:由send方法设置<br>5:JMSMessageID:由send方法设置<br>6:JMSTimestamp:由客户端设置<br>7:JMSCorrelationID:由客户端设置<br>8:JMSReplyTo:由客户端设置<br>9:JMSType:由客户端设置<br>10:JMSRedelivered:由JMSProvider设置</p>
<h3 id="标准的JMS消息头包含以下属性:">标准的JMS<strong>消息头</strong>包含以下属性:</h3><p>1:JMSDestination:消息发送的目的地:主要是指Queue和Topic,自动分配<br>2:JMSDeliveryMode:传送模式。有两种:持久模式和非持久模式。一条持久性的消息应该被传送“一次仅仅一次”,这就意味者如果JMS提供者出现故障,该消息并不会丢失,它会在服务器恢复之后再次传递。一条非持久的消息最多会传送一次,这意味这服务器出现故障,该消息将永远丢失。自动分配<br>3:JMSExpiration:消息过期时间,等于Destination的send方法中的timeToLive值加上发送时刻的GMT时间值。如果timeToLive值等于零,则JMSExpiration被设为零,表示该消息永不过期。如果发送后,在消息过期时间之后消息还没有被发送到目的地,则该消息被清除。自动分配<br>4:JMSPriority:消息优先级,从0-9十个级别,0-4是普通消息,5-9是加急消息。JMS不要求JMSProvider严格按照这十个优先级发送消息,但必须保证加急消息要先于普通消息到达。默认是4级。自动分配<br>5:JMSMessageID:唯一识别每个消息的标识,由JMSProvider产生。自动分配<br>6:JMSTimestamp:一个JMSProvider在调用send()方法时自动设置的。它是消息被发送和消费者实际接收的时间差。自动分配1:JMSDestination:消息发送的目的地:主要是指Queue和Topic,自动分配<br>7:JMSCorrelationID:<br>用来连接到另外一个消息,典型的应用是在回复消息中连接到原消息。在大多数情况下,JMSCorrelationID用于将一条消息标记为对JMSMessageID标示的上一条消息的应答,不过,JMSCorrelationID可以是任何值,不仅仅是JMSMessageID。由开发者设置<br>8:JMSReplyTo:提供本消息回复消息的目的地址。由开发者设置<br>9:JMSType:消息类型的识别符。由开发者设置<br>10:JMSRedelivered:如果一个客户端收到一个设置了JMSRedelivered属性的消息,则表示可能客户端曾经在早些时候收到过该消息,但并没有签收(acknowledged).如果该消息被重新传送,JMSRedelivered=true反之,JMSRedelivered=false。自动设置</p>
<h3 id="JMS消息体">JMS消息体</h3><p>消息体,JMSAPI定义了5种消息体格式,也叫消息类型,可以使用不同形式发送接收数据,并可以兼容现有的消息格式。包括:TextMessage、MapMessage、BytesMessage、StreamMessage和ObjectMessage<br>消息属性,包含以下三种类型的属性:<br>1:应用程序设置和添加的属性,比如:<br>Message.setStringProperty(“username”,username);<br>2:JMS定义的属性<br>使用“JMSX”作为属性名的前缀,connection.getMetaData().getJMSXPropertyNames(),方法返回所有连接支持的JMSX属性的名字。<br>3:JMS供应商特定的属性<br>JMS定义的属性如下:<br>3.1:JMSXUserID:发送消息的用户标识,发送时提供商设置<br>3.2:JMSXAppID:发送消息的应用标识,发送时提供商设置<br>3.3:JMSXDeliveryCount:转发消息重试次数,第一次是1,第二次是2,…,发送时提供商设置<br>3.4:JMSXGroupID:消息所在消息组的标识,由客户端设置<br>3.5:JMSXGroupSeq:组内消息的序号第一个消息是1,第二个是2,…,由客户端设置<br>3.6:JMSXProducerTXID:产生消息的事务的事务标识,发送时提供商设置<br>3.7:JMSXConsumerTXID:消费消息的事务的事务标识,接收时提供商设置<br>3.8:JMSXRcvTimestamp:JMS转发消息到消费者的时间,接收时提供商设置<br>3.9:JMSXState:假定存在一个消息仓库,它存储了每个消息的单独拷贝,且这些消<br>息从原始消息被发送时开始。每个拷贝的状态有:1(等待),2(准备),3(到期)或4(保留).由于状态与生产者和消费者无关,所以它不是由它们来提供。它只和在仓库中查找消息相关,因此JMS没有提供这种API。由提供商设置</p>
<h3 id="消息接受确认">消息接受确认</h3><p>JMS消息只有在被确认之后,才认为已经被成功地消费了。消息的成功消费通常包含三个阶段:<strong>客户接收消息、客户处理消息和消息被确认</strong><br>在事务性会话中,当一个事务被提交的时候,确认自动发生。在非事务性会话中,消息何时被确认取决于创建会话时的应答模式(acknowledgementmode)。该参数有以下三个可选值:<br>Session.AUTO_ACKNOWLEDGE:当客户成功的从receive方法返回的时候,<br>或者从MessageListener.onMessage方法成功返回的时候,会话自动确认客户收到的消息。<br>Session.CLIENT_ACKNOWLEDGE:客户通过调用消息的acknowledge方法确认消息。<br>需要注意的是,在这种模式中,确认是在会话层上进行,确认一个被消费的消息将自动确认所有已被会话消费的消息。<br>例如,如果一个消息消费者消费了10个消息,然后确认第5个消息,那么所有10个消息都被确认。<br>Session.DUPS_ACKNOWLEDGE:该选择只是会话迟钝的确认消息的提交。<br>如果JMSprovider失败,那么可能会导致一些重复的消息。如果是重复的消息,那么JMSprovider必须把消息头的JMSRedelivered字段设置为true</p>
<h3 id="消息持久性">消息持久性</h3><p>JMS支持以下两种消息提交模式:<br>PERSISTENT:指示JMSprovider持久保存消息,以保证消息不会因为JMSprovider的失败而丢失<br>NON_PERSISTENT:不要求JMSprovider持久保存消息</p>
<h3 id="消息优先级">消息优先级</h3><p>可以使用消息优先级来指示JMSprovider首先提交紧急的消息。优先级分10个级别,从0(最低)到9(最高)。如果不指定优先级,默认级别是4。需要<br>注意的是,JMSprovider并不一定保证按照优先级的顺序提交消息</p>
<h3 id="消息过期">消息过期</h3><p>可以设置消息在一定时间后过期,默认是永不过期</p>
<h3 id="消息的临时目的地">消息的临时目的地</h3><p>可以通过会话上的createTemporaryQueue方法和createTemporaryTopic方法来创建临时目的地。它们的存在时间只限于创建它们的连接所保持的时间。只有创建该临时目的地的连接上的消息消费者才能够从临时目的地中提取消息</p>
<h3 id="持久订阅">持久订阅</h3><p>首先消息生产者必须使用PERSISTENT提交消息。客户可以通过会话上的createDurableSubscriber方法来创建一个持久订阅,该方法的第一个参数必须是一个topic。第二个参数是订阅的名称。<br>JMSprovider会存储发布到持久订阅对应的topic上的消息。如果最初创建持久订阅的客户或者任何其它客户,使用相同的连接工厂和连接的客户ID,相同的主题和相同的订阅名,再次调用会话上的createDurableSubscriber方法,那么该持久订阅就会被激活。JMSprovider会向客户发送客户处于非激活状态时所发布的消息。<br>持久订阅在某个时刻只能有一个激活的订阅者。持久订阅在创建之后会一直保留,直到应用程序调用会话上的unsubscribe方法。</p>
<h3 id="本地事务">本地事务</h3><p>在一个JMS客户端,可以使用本地事务来组合消息的发送和接收。JMSSession接口提供了commit和rollback方法。<br>事务提交意味着生产的所有消息被发送,消费的所有消息被确认;<br>事务回滚意味着生产的所有消息被销毁,消费的所有消息被恢复并重新提交,除非它们已经过期。<br>事务性的会话总是牵涉到事务处理中,commit或rollback方法一旦被调用,一个事务就结束了,而另一个事务被开始。关闭事务性会话将回滚其中的事务。<br>需要注意的是,如果使用请求/回复机制,即发送一个消息,同时希望在同一个事务中等待接收该消息的回复,那么程序将被挂起,因为知道事务提交,发送操作才会真正执行。<br><strong>需要注意的还有一个,消息的生产和消费不能包含在同一个事务中</strong></p>
<h3 id="JMS的PTP模型">JMS的PTP模型</h3><p>JMSPTP(Point-to-Point)模型定义了客户端如何向队列发送消息,从队列接收消息,以及浏览队列中的消息。<br>PTP模型是基于队列的,生产者发消息到队列,消费者从队列接收消息,队列的存在使得消息的异步传输成为可能。和邮件系统中的邮箱一样,队列可以包含各种消息,JMSProvider提供工具管理队列的创建、删除。<br>PTP的一些特点:<br>1:如果在Session关闭时,有一些消息已经被收到,但还没有被签收(acknowledged),那么,当消费者下次连接到相同的队列时,这些消息还会被再次接收<br>2:如果用户在receive方法中设定了消息选择条件,那么不符合条件的消息会留在队列中,不会被接收到3:队列可以长久地保存消息直到消费者收到消息。消费者不需要因为担心消息会丢失而时刻和队列保持激活的连接状态,充分体现了异步传输模式的优势</p>
<h3 id="JMS的Pub/Sub模型">JMS的Pub/Sub模型</h3><p>JMSPub/Sub模型定义了如何向一个内容节点发布和订阅消息,这些节点被称作topic主题可以被认为是消息的传输中介,发布者(publisher)发布消息到主题,订阅者<br>(subscribe)从主题订阅消息。主题使得消息订阅者和消息发布者保持互相独立,不需要接触即可保证消息的传送。<br>Pub/Sub的一些特点:<br>1:消息订阅分为非持久订阅和持久订阅<br><code>非持久订阅</code>只有当客户端处于激活状态,也就是和JMSProvider保持连接状态才能收到发送到某个主题的消息,而当客户端处于离线状态,这个时间段发到主题的消息将会丢失,永远不会收到。<br><code>持久订阅</code>时,客户端向JMS注册一个识别自己身份的ID,当这个客户端处于离线时,JMSProvider会为这个ID保存所有发送到主题的消息,当客户再次连接到JMSProvider时,会根据自己的ID得到所有当自己处于离线时发送到主题的消息。<br>2:如果用户在receive方法中设定了消息选择条件,那么不符合条件的消息不会被接收<br>3:非持久订阅状态下,不能恢复或重新派送一个未签收的消息。只有持久订阅才能恢复或重新派送一个未签收的消息。<br>4:当所有的消息必须被接收,则用持久订阅。当丢失消息能够被容忍,则用非持久订阅</p>
<h2 id="一个JMS应用的基本步骤">一个JMS应用的基本步骤</h2><p>JMS开发的基本步骤<br>1:创建一个JMSconnectionfactory<br>2:通过connectionfactory来创建JMSconnection<br>3:启动JMSconnection<br>4:通过connection创建JMSsession<br>5:创建JMSdestination<br>6:创建JMSproducer,或者创建JMSmessage,并设置destination<br>7:创建JMSconsumer,或者是注册一个JMSmessagelistener<br>8:发送或者接受JMSmessage(s)<br>9:关闭所有的JMS资源(connection,session,producer,consumer等)</p>
<h3 id="非持久的Topic消息示例">非持久的Topic消息示例</h3><p>对于非持久的Topic消息的发送基本跟前面发送队列信息是一样的,只是把创建Destination的地方,由创建队列替换成创建Topic,例如:<br><code>Destinationdestination=session.createTopic(&quot;MyTopic&quot;);</code><br>对于非持久的Topic消息的接收<br>1:必须要接收方在线,然后客户端再发送信息,接收方才能接收到消息<br>2:同样把创建Destination的地方,由创建队列替换成创建Topic,例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Destination destination=session.createTopic(<span class="string">"MyTopic"</span>);</span><br></pre></td></tr></table></figure></p>
<p>3:由于不知道客户端发送多少信息,因此改成while循环的方式了,例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Message message=consumer.receive();</span><br><span class="line"><span class="keyword">while</span>(message!=<span class="keyword">null</span>)&#123;</span><br><span class="line">	TextMessage txtMsg=(TextMessage)message;</span><br><span class="line">	System.out.println(<span class="string">"收到消息:"</span>+txtMsg.getText());</span><br><span class="line">	message=consumer.receive(<span class="number">1000L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="持久的Topic消息示例-发送">持久的Topic消息示例-发送</h3><p>对于持久的Topic消息的发送<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">ConnectionFactory connectionFactory=<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.1.106:61616"</span>);</span><br><span class="line">Connectionconnection=connectionFactory.createConnection();</span><br><span class="line">Session session=connection.createSession(Boolean.TRUE,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">Topic destination=session.createTopic(<span class="string">"MyTopic"</span>);</span><br><span class="line">MessageProducer producer=session.createProducer(destination);</span><br><span class="line">producer.setDeliveryMode(DeliveryMode.PERSISTENT);</span><br><span class="line">connection.start();</span><br><span class="line"><span class="keyword">for</span>(inti=<span class="number">0</span>;i&lt;<span class="number">2</span>;i++)&#123;</span><br><span class="line">TextMessage message=session.createTextMessage(<span class="string">"messagedd--"</span>+i);Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">//通过消息生产者发出消息</span></span><br><span class="line">producer.send(message);</span><br><span class="line">&#125;</span><br><span class="line">session.commit();</span><br><span class="line">session.close();</span><br><span class="line">connection.close();</span><br></pre></td></tr></table></figure></p>
<p>1:要用持久化订阅,发送消息者要用<code>DeliveryMode.PERSISTENT</code>模式发现,在连接之前设定<br>2:一定要设置完成后,再start这个connection</p>
<h3 id="持久的Topic消息示例-接受">持久的Topic消息示例-接受</h3><p>对于持久的Topic消息的接收<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ConnectionFactory cf=<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.1.106:61616"</span>);</span><br><span class="line">Connection connection=cf.createConnection();</span><br><span class="line">connection.setClientID(<span class="string">"cc1"</span>);</span><br><span class="line"><span class="keyword">final</span> Session session=connection.createSession(Boolean.TRUE,Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">Topic destination=session.createTopic(<span class="string">"MyTopic"</span>);</span><br><span class="line">Topic Subscriberts=session.createDurableSubscriber(destination,<span class="string">"T1"</span>);connection.start();</span><br><span class="line">Message message=ts.receive();<span class="keyword">while</span>(message!=<span class="keyword">null</span>)&#123;</span><br><span class="line">TextMessage txtMsg=(TextMessage)message;</span><br><span class="line">session.commit();</span><br><span class="line">System.out.println(<span class="string">"收到消息:"</span>+txtMsg.getText());message=ts.receive(<span class="number">1000L</span>);</span><br><span class="line">&#125;</span><br><span class="line">session.close();</span><br><span class="line">connection.close();</span><br></pre></td></tr></table></figure></p>
<p>1:需要在连接上设置消费者id,用来识别消费者<br>2:需要创建TopicSubscriber来订阅<br>3:要设置好了过后再start这个connection<br>4:<strong>一定要先运行一次,等于向消息服务中间件注册这个消费者,然后再运行客户端发送信息,这个时候,无论消费者是否在线,都会接收到,不在线的话,下次连接的时候,会把没有收过的消息都接收下来。</strong></p>
<h3 id="关于持久化和非持久化消息">关于持久化和非持久化消息</h3><p>持久化消息<br>这是ActiveMQ的默认传送模式,此模式保证这些消息只被传送一次和成功使用一次。对于这些消息,可靠性是优先考虑的因素。可靠性的另一个重要方面是确保持久性消息传送至目标后,消息服务在向消费者传送它们之前不会丢失这些消息。这意味着在持久性消息传送至目标时,消息服务将其放入持久性数据存储。如果消息服务由于某种原因导致失败,它可以恢复此消息并将此消息传送至相应的消费者。虽然这样增加了消息传送的开销,但却增加了可靠性。<br>非持久化消息<br>保证这些消息最多被传送一次。对于这些消息,可靠性并非主要的考虑因素。此模式并不要求持久性的数据存储,也不保证消息服务由于某种原因导致失败后消息不会丢失。有两种方法指定传送模式:<br>1.使用setDeliveryMode方法,这样所有的消息都采用此传送模式;如:<code>producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);</code><br>2.使用send方法为每一条消息设置传送模式</p>


        
          <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- artical f2 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-9404963564058219"
     data-ad-slot="7102642795"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
        
        
      
    </div>
    <footer class="article-footer">
      
        <a data-url="http://14686039.github.io/2015/11/26/activeMQ快速上手/" data-id="cixqxn61n001u6o3nkwzqg3p0" class="article-share-link" data-share="baidu" data-title="activeMQ快速上手">分享到</a>
      

      
        <a href="http://14686039.github.io/2015/11/26/activeMQ快速上手/#ds-thread" class="article-comment-link">评论</a>
      

      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ActiveMQ/">ActiveMQ</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/11/30/java自动生成图像/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          java自动生成图像
        
      </div>
    </a>
  
  
    <a href="/2015/11/12/Mac下SSH终端证书方式到远程服务器/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">Mac下SSH终端证书方式到远程服务器</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="2015/11/26/activeMQ快速上手/" data-title="activeMQ快速上手" data-url="http://14686039.github.io/2015/11/26/activeMQ快速上手/"></div>
  </section>
</section>
      
      <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/">ActiveMQ</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-Tomcat/">Java Tomcat</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MAC/">MAC</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MAC-SSH/">MAC , SSH</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swift2/">Swift2</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript/">javascript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mac/">mac</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swift/">swift</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模型/">设计模型</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">18</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/ActiveMQ/" style="font-size: 13.33px;">ActiveMQ</a> <a href="/tags/Java-Tomcat/" style="font-size: 10px;">Java Tomcat</a> <a href="/tags/MAC/" style="font-size: 13.33px;">MAC</a> <a href="/tags/MAC-SSH/" style="font-size: 10px;">MAC , SSH</a> <a href="/tags/Swift2/" style="font-size: 10px;">Swift2</a> <a href="/tags/java/" style="font-size: 16.67px;">java</a> <a href="/tags/javascript/" style="font-size: 10px;">javascript</a> <a href="/tags/mac/" style="font-size: 10px;">mac</a> <a href="/tags/swift/" style="font-size: 10px;">swift</a> <a href="/tags/设计模型/" style="font-size: 10px;">设计模型</a> <a href="/tags/设计模式/" style="font-size: 20px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">20</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/01/10/Annotation-使用案例/">Annotation 使用案例</a>
          </li>
        
          <li>
            <a href="/2017/01/05/自定义类加载器和动态加载-Java-代码/">自定义类加载器和动态加载 Java 代码</a>
          </li>
        
          <li>
            <a href="/2016/12/26/java-对象池技术/">java 对象池技术</a>
          </li>
        
          <li>
            <a href="/2016/11/17/设计模式-状态模式/">设计模式-状态模式</a>
          </li>
        
          <li>
            <a href="/2016/11/17/设计模式-备忘录模式/">设计模式-备忘录模式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">友情链接</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="http://vividict.com" target="_blank">在线字典</a>
          </li>
        
          <li>
            <a href="https://www.cmacapps.com/" target="_blank">破解Mac软件</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 唐顺<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于我</a>
  
</nav>
  <!-- totop start -->
<div id="totop">
<a title="返回顶部"><img src="/img/scrollup.png"/></a>
</div>

<!-- totop end -->

<!-- 多说公共js代码 start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"14686039"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- 多说公共js代码 end -->


<!-- 百度分享 start -->

<div id="article-share-box" class="article-share-box">
  <div id="bdshare" class="bdsharebuttonbox article-share-links">
    <a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a>
    <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a>
    <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a>
    <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a>
    <a class="article-share-more" data-cmd="more" title="更多"></a>
  </div>
</div>
<script>
  function SetShareData(cmd, config) {
    if (shareDataTitle && shareDataUrl) {
      config.bdText = shareDataTitle;
      config.bdUrl = shareDataUrl;
    }
    return config;
  }
  window._bd_share_config={
    "common":{onBeforeClick: SetShareData},
    "share":{"bdCustomStyle":"/css/bdshare.css"}
  };
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

<!-- 百度分享 end -->

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>




<! -- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
                processEscapes: true
                    
}
  
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
                  
}
    
        });
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Queue(function() {
            var all = MathJax.Hub.getAllJax(), i;
            for(i=0; i < all.length; i += 1) {
                            all[i].SourceElement().parentNode.className += ' has-jax';
                                    
            }
                
        });
</script>

<script type="text/javascript" src="http://cdn.bootcss.com/mathjax/2.5.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<script src="/js/script.js" type="text/javascript"></script>

</div>
<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
</body>
</html>
